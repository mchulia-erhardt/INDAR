# Propuesta de Base de Datos - Gestión de Usuarios y Perfiles

## Contexto del Proyecto

**Aplicación:** RASMIA - Sistema de tramitación de expedientes  
**Stack Tecnológico:** Java 11 + Spring Boot + Oracle 19c + Angular  
**Autenticación:** Integración con MFE de Gobierno de Aragón (Cl@ve, Certificado Digital)

---

## 1. DISEÑO DE TABLAS PRINCIPALES

### 1.1 Tabla de Usuarios (USUARIO)

Almacena la información básica de cada usuario del sistema. Un usuario es único y puede tener múltiples perfiles asociados.

```sql
CREATE TABLE USUARIO (
    ID_USUARIO NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    IDENTIFICADOR VARCHAR2(50) NOT NULL UNIQUE, -- NIF/NIE del usuario (viene de Cl@ve/Certificado)
    NOMBRE VARCHAR2(100) NOT NULL,
    APELLIDO1 VARCHAR2(100) NOT NULL,
    APELLIDO2 VARCHAR2(100),
    EMAIL VARCHAR2(255),
    TELEFONO VARCHAR2(20),
    FECHA_ALTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FECHA_MODIFICACION TIMESTAMP,
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL, -- ACTIVO, BLOQUEADO, BAJA
    USUARIO_CREACION VARCHAR2(50),
    USUARIO_MODIFICACION VARCHAR2(50),
    CONSTRAINT CHK_USUARIO_ESTADO CHECK (ESTADO IN ('ACTIVO', 'BLOQUEADO', 'BAJA'))
);

CREATE INDEX IDX_USUARIO_IDENTIFICADOR ON USUARIO(IDENTIFICADOR);
CREATE INDEX IDX_USUARIO_ESTADO ON USUARIO(ESTADO);

COMMENT ON TABLE USUARIO IS 'Tabla principal de usuarios del sistema';
COMMENT ON COLUMN USUARIO.IDENTIFICADOR IS 'NIF/NIE obtenido de Cl@ve o Certificado Digital';
COMMENT ON COLUMN USUARIO.ESTADO IS 'ACTIVO: puede acceder | BLOQUEADO: acceso denegado | BAJA: usuario eliminado';
```

---

### 1.2 Catálogo de Tipos de Perfil (TIPO_PERFIL)

Define los tipos de perfiles disponibles en el sistema. Permite configuración dinámica de perfiles y jerarquías.

```sql
CREATE TABLE TIPO_PERFIL (
    ID_TIPO_PERFIL NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    CODIGO VARCHAR2(50) NOT NULL UNIQUE, -- TITULAR, REPRESENTANTE, TRABAJADOR_EMPRESA, etc.
    NOMBRE VARCHAR2(100) NOT NULL,
    DESCRIPCION VARCHAR2(500),
    REQUIERE_ENTIDAD NUMBER(1) DEFAULT 0 NOT NULL, -- 0=No, 1=Sí (si necesita empresa, organismo, etc.)
    REQUIERE_ACTIVACION NUMBER(1) DEFAULT 0 NOT NULL, -- 0=Auto-activado, 1=Requiere aprobación
    ID_TIPO_PERFIL_PADRE NUMBER, -- Para jerarquía de perfiles
    ORDEN_JERARQUICO NUMBER, -- Para ordenar perfiles por nivel jerárquico
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL,
    FECHA_ALTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FECHA_MODIFICACION TIMESTAMP,
    CONSTRAINT FK_TIPO_PERFIL_PADRE FOREIGN KEY (ID_TIPO_PERFIL_PADRE) 
        REFERENCES TIPO_PERFIL(ID_TIPO_PERFIL),
    CONSTRAINT CHK_TIPO_PERFIL_ESTADO CHECK (ESTADO IN ('ACTIVO', 'INACTIVO'))
);

CREATE INDEX IDX_TIPO_PERFIL_CODIGO ON TIPO_PERFIL(CODIGO);
CREATE INDEX IDX_TIPO_PERFIL_PADRE ON TIPO_PERFIL(ID_TIPO_PERFIL_PADRE);

COMMENT ON TABLE TIPO_PERFIL IS 'Catálogo de tipos de perfiles del sistema';
COMMENT ON COLUMN TIPO_PERFIL.CODIGO IS 'Códigos: TITULAR, REPRESENTANTE_TITULAR, TRABAJADOR_EMPRESA, TRABAJADOR_ORGANISMO, SERVICIO_CENTRAL, SERVICIO_PROVINCIAL';
COMMENT ON COLUMN TIPO_PERFIL.REQUIERE_ENTIDAD IS '1 si el perfil debe estar vinculado a una entidad (empresa, organismo, etc.)';
COMMENT ON COLUMN TIPO_PERFIL.REQUIERE_ACTIVACION IS '0 si el perfil se activa automáticamente (ej: TITULAR), 1 si requiere aprobación';
COMMENT ON COLUMN TIPO_PERFIL.ORDEN_JERARQUICO IS 'Nivel jerárquico del perfil para establecer precedencias';
```

**Datos iniciales:**

```sql
INSERT INTO TIPO_PERFIL (CODIGO, NOMBRE, DESCRIPCION, REQUIERE_ENTIDAD, REQUIERE_ACTIVACION, ORDEN_JERARQUICO) VALUES
('TITULAR', 'Titular', 'Perfil de titular, auto-asignado al usuario', 0, 0, 10);

INSERT INTO TIPO_PERFIL (CODIGO, NOMBRE, DESCRIPCION, REQUIERE_ENTIDAD, REQUIERE_ACTIVACION, ORDEN_JERARQUICO) VALUES
('REPRESENTANTE_TITULAR', 'Representante de Titular', 'Representante autorizado de un titular', 0, 1, 15);

INSERT INTO TIPO_PERFIL (CODIGO, NOMBRE, DESCRIPCION, REQUIERE_ENTIDAD, REQUIERE_ACTIVACION, ORDEN_JERARQUICO) VALUES
('TRABAJADOR_EMPRESA', 'Trabajador de Empresa', 'Trabajador vinculado a una empresa', 1, 1, 20);

INSERT INTO TIPO_PERFIL (CODIGO, NOMBRE, DESCRIPCION, REQUIERE_ENTIDAD, REQUIERE_ACTIVACION, ORDEN_JERARQUICO) VALUES
('TRABAJADOR_ORGANISMO', 'Trabajador de Organismo de Control', 'Trabajador de organismo de control', 1, 1, 25);

INSERT INTO TIPO_PERFIL (CODIGO, NOMBRE, DESCRIPCION, REQUIERE_ENTIDAD, REQUIERE_ACTIVACION, ORDEN_JERARQUICO) VALUES
('SERVICIO_PROVINCIAL', 'Servicio Provincial', 'Usuario de servicios provinciales', 1, 1, 30);

INSERT INTO TIPO_PERFIL (CODIGO, NOMBRE, DESCRIPCION, REQUIERE_ENTIDAD, REQUIERE_ACTIVACION, ORDEN_JERARQUICO) VALUES
('SERVICIO_CENTRAL', 'Servicio Central', 'Usuario de servicios centrales', 0, 1, 40);

COMMIT;
```

---

### 1.3 Entidades Asociadas (ENTIDAD)

Almacena las entidades a las que pueden estar vinculados los perfiles (empresas, organismos, servicios provinciales, etc.).

```sql
CREATE TABLE ENTIDAD (
    ID_ENTIDAD NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    TIPO_ENTIDAD VARCHAR2(50) NOT NULL, -- EMPRESA, ORGANISMO_CONTROL, SERVICIO_PROVINCIAL, etc.
    CODIGO VARCHAR2(50) NOT NULL,
    NOMBRE VARCHAR2(255) NOT NULL,
    CIF_NIF VARCHAR2(20),
    ID_PROVINCIA NUMBER, -- Para servicios provinciales
    DATOS_ADICIONALES CLOB, -- JSON con info específica de cada tipo de entidad
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVA' NOT NULL,
    FECHA_ALTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FECHA_MODIFICACION TIMESTAMP,
    CONSTRAINT UQ_ENTIDAD_TIPO_CODIGO UNIQUE (TIPO_ENTIDAD, CODIGO),
    CONSTRAINT CHK_ENTIDAD_ESTADO CHECK (ESTADO IN ('ACTIVA', 'INACTIVA'))
);

CREATE INDEX IDX_ENTIDAD_TIPO ON ENTIDAD(TIPO_ENTIDAD);
CREATE INDEX IDX_ENTIDAD_CODIGO ON ENTIDAD(CODIGO);
CREATE INDEX IDX_ENTIDAD_PROVINCIA ON ENTIDAD(ID_PROVINCIA);

COMMENT ON TABLE ENTIDAD IS 'Entidades asociadas a perfiles (empresas, organismos, servicios provinciales)';
COMMENT ON COLUMN ENTIDAD.TIPO_ENTIDAD IS 'EMPRESA, ORGANISMO_CONTROL, SERVICIO_PROVINCIAL, etc.';
COMMENT ON COLUMN ENTIDAD.DATOS_ADICIONALES IS 'Información adicional en formato JSON específica del tipo de entidad';
```

---

### 1.4 Perfiles de Usuario (USUARIO_PERFIL)

Tabla de relación entre usuarios y perfiles. Un usuario puede tener múltiples perfiles, y un perfil puede estar vinculado a una entidad específica.

```sql
CREATE TABLE USUARIO_PERFIL (
    ID_USUARIO_PERFIL NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NOT NULL,
    ID_TIPO_PERFIL NUMBER NOT NULL,
    ID_ENTIDAD NUMBER, -- Null si el perfil no requiere entidad
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL, -- ACTIVO, PENDIENTE, INACTIVO, RECHAZADO
    FECHA_ALTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FECHA_ACTIVACION TIMESTAMP,
    FECHA_BAJA TIMESTAMP,
    MOTIVO_BAJA VARCHAR2(500),
    USUARIO_ALTA VARCHAR2(50),
    USUARIO_APROBACION VARCHAR2(50), -- Quien aprobó el perfil si requiere activación
    CONSTRAINT FK_USUARIO_PERFIL_USUARIO FOREIGN KEY (ID_USUARIO) 
        REFERENCES USUARIO(ID_USUARIO),
    CONSTRAINT FK_USUARIO_PERFIL_TIPO FOREIGN KEY (ID_TIPO_PERFIL) 
        REFERENCES TIPO_PERFIL(ID_TIPO_PERFIL),
    CONSTRAINT FK_USUARIO_PERFIL_ENTIDAD FOREIGN KEY (ID_ENTIDAD) 
        REFERENCES ENTIDAD(ID_ENTIDAD),
    CONSTRAINT UQ_USUARIO_PERFIL UNIQUE (ID_USUARIO, ID_TIPO_PERFIL, ID_ENTIDAD),
    CONSTRAINT CHK_USUARIO_PERFIL_ESTADO CHECK (ESTADO IN ('ACTIVO', 'PENDIENTE', 'INACTIVO', 'RECHAZADO'))
);

CREATE INDEX IDX_USUARIO_PERFIL_USUARIO ON USUARIO_PERFIL(ID_USUARIO);
CREATE INDEX IDX_USUARIO_PERFIL_TIPO ON USUARIO_PERFIL(ID_TIPO_PERFIL);
CREATE INDEX IDX_USUARIO_PERFIL_ENTIDAD ON USUARIO_PERFIL(ID_ENTIDAD);
CREATE INDEX IDX_USUARIO_PERFIL_ESTADO ON USUARIO_PERFIL(ESTADO);

COMMENT ON TABLE USUARIO_PERFIL IS 'Asignación de perfiles a usuarios';
COMMENT ON COLUMN USUARIO_PERFIL.ESTADO IS 'ACTIVO: perfil activo | PENDIENTE: esperando aprobación | INACTIVO: desactivado | RECHAZADO: solicitud rechazada';
COMMENT ON COLUMN USUARIO_PERFIL.ID_ENTIDAD IS 'Entidad asociada al perfil (empresa, organismo). NULL si el tipo de perfil no requiere entidad';
```

---

## 2. GESTIÓN DE PERMISOS Y FUNCIONALIDADES

### 2.1 Catálogo de Funcionalidades (FUNCIONALIDAD)

Define el árbol de funcionalidades del sistema: menús, secciones, pantallas, acciones y botones.

```sql
CREATE TABLE FUNCIONALIDAD (
    ID_FUNCIONALIDAD NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    CODIGO VARCHAR2(100) NOT NULL UNIQUE,
    NOMBRE VARCHAR2(200) NOT NULL,
    DESCRIPCION VARCHAR2(500),
    TIPO VARCHAR2(50) NOT NULL, -- MENU, SECCION, PANTALLA, ACCION, BOTON
    ID_FUNCIONALIDAD_PADRE NUMBER, -- Para crear árbol de funcionalidades
    RUTA VARCHAR2(500), -- Ruta del componente Angular
    ORDEN NUMBER DEFAULT 0,
    ICONO VARCHAR2(100),
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVA' NOT NULL,
    FECHA_ALTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT FK_FUNCIONALIDAD_PADRE FOREIGN KEY (ID_FUNCIONALIDAD_PADRE) 
        REFERENCES FUNCIONALIDAD(ID_FUNCIONALIDAD),
    CONSTRAINT CHK_FUNCIONALIDAD_TIPO CHECK (TIPO IN ('MENU', 'SECCION', 'PANTALLA', 'ACCION', 'BOTON')),
    CONSTRAINT CHK_FUNCIONALIDAD_ESTADO CHECK (ESTADO IN ('ACTIVA', 'INACTIVA'))
);

CREATE INDEX IDX_FUNCIONALIDAD_CODIGO ON FUNCIONALIDAD(CODIGO);
CREATE INDEX IDX_FUNCIONALIDAD_PADRE ON FUNCIONALIDAD(ID_FUNCIONALIDAD_PADRE);
CREATE INDEX IDX_FUNCIONALIDAD_TIPO ON FUNCIONALIDAD(TIPO);

COMMENT ON TABLE FUNCIONALIDAD IS 'Catálogo jerárquico de funcionalidades del sistema';
COMMENT ON COLUMN FUNCIONALIDAD.TIPO IS 'MENU=Menú principal, SECCION=Sección dentro de menú, PANTALLA=Vista completa, ACCION=Operación específica, BOTON=Elemento UI';
COMMENT ON COLUMN FUNCIONALIDAD.RUTA IS 'Ruta del componente Angular (ej: /expedientes/listado)';
```

**Ejemplo de datos iniciales:**

```sql
-- Menú principal
INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ORDEN, ICONO) VALUES
('MENU_EXPEDIENTES', 'Expedientes', 'MENU', 1, 'folder');

-- Secciones del menú
INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ID_FUNCIONALIDAD_PADRE, RUTA, ORDEN) VALUES
('SECCION_EXPEDIENTES_LISTADO', 'Listado de Expedientes', 'SECCION', 
    (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'MENU_EXPEDIENTES'), 
    '/expedientes/listado', 1);

INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ID_FUNCIONALIDAD_PADRE, RUTA, ORDEN) VALUES
('SECCION_EXPEDIENTES_NUEVO', 'Nuevo Expediente', 'SECCION', 
    (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'MENU_EXPEDIENTES'), 
    '/expedientes/nuevo', 2);

-- Pantallas
INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ID_FUNCIONALIDAD_PADRE, RUTA) VALUES
('PANTALLA_EXPEDIENTE_DETALLE', 'Detalle de Expediente', 'PANTALLA', 
    (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'SECCION_EXPEDIENTES_LISTADO'), 
    '/expedientes/:id/detalle');

-- Acciones en pantalla
INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ID_FUNCIONALIDAD_PADRE) VALUES
('ACCION_EXPEDIENTE_CREAR', 'Crear Expediente', 'ACCION', 
    (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'SECCION_EXPEDIENTES_NUEVO'));

INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ID_FUNCIONALIDAD_PADRE) VALUES
('ACCION_EXPEDIENTE_EDITAR', 'Editar Expediente', 'ACCION', 
    (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'PANTALLA_EXPEDIENTE_DETALLE'));

-- Botones específicos
INSERT INTO FUNCIONALIDAD (CODIGO, NOMBRE, TIPO, ID_FUNCIONALIDAD_PADRE) VALUES
('BOTON_EXPEDIENTE_APROBAR', 'Botón Aprobar Expediente', 'BOTON', 
    (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'PANTALLA_EXPEDIENTE_DETALLE'));

COMMIT;
```

---

### 2.2 Permisos por Perfil (PERFIL_PERMISO)

Asigna permisos a cada tipo de perfil sobre las funcionalidades del sistema.

```sql
CREATE TABLE PERFIL_PERMISO (
    ID_PERFIL_PERMISO NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ID_TIPO_PERFIL NUMBER NOT NULL,
    ID_FUNCIONALIDAD NUMBER NOT NULL,
    TIPO_PERMISO VARCHAR2(20) NOT NULL, -- LECTURA, ESCRITURA, EJECUCION, COMPLETO
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVO' NOT NULL,
    FECHA_ALTA TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FECHA_BAJA TIMESTAMP,
    USUARIO_ALTA VARCHAR2(50),
    CONSTRAINT FK_PERFIL_PERMISO_PERFIL FOREIGN KEY (ID_TIPO_PERFIL) 
        REFERENCES TIPO_PERFIL(ID_TIPO_PERFIL),
    CONSTRAINT FK_PERFIL_PERMISO_FUNCIONALIDAD FOREIGN KEY (ID_FUNCIONALIDAD) 
        REFERENCES FUNCIONALIDAD(ID_FUNCIONALIDAD),
    CONSTRAINT UQ_PERFIL_PERMISO UNIQUE (ID_TIPO_PERFIL, ID_FUNCIONALIDAD, TIPO_PERMISO),
    CONSTRAINT CHK_PERFIL_PERMISO_TIPO CHECK (TIPO_PERMISO IN ('LECTURA', 'ESCRITURA', 'EJECUCION', 'COMPLETO')),
    CONSTRAINT CHK_PERFIL_PERMISO_ESTADO CHECK (ESTADO IN ('ACTIVO', 'INACTIVO'))
);

CREATE INDEX IDX_PERFIL_PERMISO_PERFIL ON PERFIL_PERMISO(ID_TIPO_PERFIL);
CREATE INDEX IDX_PERFIL_PERMISO_FUNCIONALIDAD ON PERFIL_PERMISO(ID_FUNCIONALIDAD);

COMMENT ON TABLE PERFIL_PERMISO IS 'Permisos asignados a cada tipo de perfil';
COMMENT ON COLUMN PERFIL_PERMISO.TIPO_PERMISO IS 'LECTURA: solo consultar | ESCRITURA: crear/modificar | EJECUCION: ejecutar acciones | COMPLETO: todos los permisos';
```

**Ejemplo de asignación de permisos:**

```sql
-- TITULAR puede ver listado de expedientes
INSERT INTO PERFIL_PERMISO (ID_TIPO_PERFIL, ID_FUNCIONALIDAD, TIPO_PERMISO) VALUES
((SELECT ID_TIPO_PERFIL FROM TIPO_PERFIL WHERE CODIGO = 'TITULAR'),
 (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'SECCION_EXPEDIENTES_LISTADO'),
 'LECTURA');

-- TITULAR puede crear expedientes
INSERT INTO PERFIL_PERMISO (ID_TIPO_PERFIL, ID_FUNCIONALIDAD, TIPO_PERMISO) VALUES
((SELECT ID_TIPO_PERFIL FROM TIPO_PERFIL WHERE CODIGO = 'TITULAR'),
 (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'ACCION_EXPEDIENTE_CREAR'),
 'EJECUCION');

-- SERVICIO_CENTRAL tiene permisos completos sobre expedientes
INSERT INTO PERFIL_PERMISO (ID_TIPO_PERFIL, ID_FUNCIONALIDAD, TIPO_PERMISO) VALUES
((SELECT ID_TIPO_PERFIL FROM TIPO_PERFIL WHERE CODIGO = 'SERVICIO_CENTRAL'),
 (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'MENU_EXPEDIENTES'),
 'COMPLETO');

-- Solo SERVICIO_CENTRAL puede aprobar expedientes
INSERT INTO PERFIL_PERMISO (ID_TIPO_PERFIL, ID_FUNCIONALIDAD, TIPO_PERMISO) VALUES
((SELECT ID_TIPO_PERFIL FROM TIPO_PERFIL WHERE CODIGO = 'SERVICIO_CENTRAL'),
 (SELECT ID_FUNCIONALIDAD FROM FUNCIONALIDAD WHERE CODIGO = 'BOTON_EXPEDIENTE_APROBAR'),
 'EJECUCION');

COMMIT;
```

---

## 3. AUDITORÍA

### 3.1 Auditoría de Accesos (AUDITORIA_ACCESO)

Registra todos los accesos al sistema con información detallada de la sesión.

```sql
CREATE TABLE AUDITORIA_ACCESO (
    ID_AUDITORIA_ACCESO NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NOT NULL,
    ID_USUARIO_PERFIL NUMBER NOT NULL,
    FECHA_ACCESO TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    TIPO_AUTENTICACION VARCHAR2(50), -- CLAVE, CERTIFICADO_DIGITAL
    IP_ORIGEN VARCHAR2(50),
    NAVEGADOR VARCHAR2(200),
    DISPOSITIVO VARCHAR2(200),
    SESION_ID VARCHAR2(255), -- ID de sesión para tracking
    FECHA_CIERRE_SESION TIMESTAMP,
    DURACION_SESION NUMBER, -- En segundos
    CONSTRAINT FK_AUDITORIA_USUARIO FOREIGN KEY (ID_USUARIO) 
        REFERENCES USUARIO(ID_USUARIO),
    CONSTRAINT FK_AUDITORIA_USUARIO_PERFIL FOREIGN KEY (ID_USUARIO_PERFIL) 
        REFERENCES USUARIO_PERFIL(ID_USUARIO_PERFIL)
);

CREATE INDEX IDX_AUDITORIA_USUARIO ON AUDITORIA_ACCESO(ID_USUARIO);
CREATE INDEX IDX_AUDITORIA_FECHA ON AUDITORIA_ACCESO(FECHA_ACCESO);
CREATE INDEX IDX_AUDITORIA_PERFIL ON AUDITORIA_ACCESO(ID_USUARIO_PERFIL);
CREATE INDEX IDX_AUDITORIA_SESION ON AUDITORIA_ACCESO(SESION_ID);

COMMENT ON TABLE AUDITORIA_ACCESO IS 'Auditoría de accesos al sistema';
COMMENT ON COLUMN AUDITORIA_ACCESO.SESION_ID IS 'Identificador único de sesión generado en cada login';
COMMENT ON COLUMN AUDITORIA_ACCESO.DURACION_SESION IS 'Duración de la sesión en segundos';
```

**Particionado por meses para optimizar consultas históricas:**

```sql
ALTER TABLE AUDITORIA_ACCESO 
    MODIFY PARTITION BY RANGE (FECHA_ACCESO) INTERVAL (NUMTOYMINTERVAL(1,'MONTH'))
    (PARTITION p_inicial VALUES LESS THAN (TO_DATE('2026-01-01','YYYY-MM-DD')));
```

---

### 3.2 Auditoría de Acciones (AUDITORIA_ACCION)

Para implementación futura: registra acciones específicas realizadas por los usuarios dentro del sistema.

```sql
CREATE TABLE AUDITORIA_ACCION (
    ID_AUDITORIA_ACCION NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ID_AUDITORIA_ACCESO NUMBER NOT NULL,
    ID_FUNCIONALIDAD NUMBER NOT NULL,
    FECHA_ACCION TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    TIPO_ACCION VARCHAR2(50) NOT NULL, -- CONSULTA, CREACION, MODIFICACION, ELIMINACION
    ENTIDAD_AFECTADA VARCHAR2(100), -- Tabla o entidad afectada
    ID_REGISTRO_AFECTADO NUMBER, -- ID del registro afectado
    DATOS_ANTERIORES CLOB, -- JSON con datos previos
    DATOS_NUEVOS CLOB, -- JSON con datos nuevos
    RESULTADO VARCHAR2(20), -- EXITO, ERROR
    MENSAJE_ERROR VARCHAR2(1000),
    CONSTRAINT FK_AUDITORIA_ACCION_ACCESO FOREIGN KEY (ID_AUDITORIA_ACCESO) 
        REFERENCES AUDITORIA_ACCESO(ID_AUDITORIA_ACCESO),
    CONSTRAINT FK_AUDITORIA_ACCION_FUNCIONALIDAD FOREIGN KEY (ID_FUNCIONALIDAD) 
        REFERENCES FUNCIONALIDAD(ID_FUNCIONALIDAD),
    CONSTRAINT CHK_AUDITORIA_TIPO_ACCION CHECK (TIPO_ACCION IN ('CONSULTA', 'CREACION', 'MODIFICACION', 'ELIMINACION')),
    CONSTRAINT CHK_AUDITORIA_RESULTADO CHECK (RESULTADO IN ('EXITO', 'ERROR'))
);

CREATE INDEX IDX_AUDITORIA_ACCION_ACCESO ON AUDITORIA_ACCION(ID_AUDITORIA_ACCESO);
CREATE INDEX IDX_AUDITORIA_ACCION_FECHA ON AUDITORIA_ACCION(FECHA_ACCION);
CREATE INDEX IDX_AUDITORIA_ACCION_TIPO ON AUDITORIA_ACCION(TIPO_ACCION);
CREATE INDEX IDX_AUDITORIA_ACCION_ENTIDAD ON AUDITORIA_ACCION(ENTIDAD_AFECTADA, ID_REGISTRO_AFECTADO);

COMMENT ON TABLE AUDITORIA_ACCION IS 'Auditoría detallada de acciones realizadas en el sistema (implementación futura)';
COMMENT ON COLUMN AUDITORIA_ACCION.DATOS_ANTERIORES IS 'Estado anterior del registro en formato JSON';
COMMENT ON COLUMN AUDITORIA_ACCION.DATOS_NUEVOS IS 'Estado nuevo del registro en formato JSON';
```

---

## 4. VISTAS ÚTILES

### 4.1 Vista de Perfiles Activos por Usuario

```sql
CREATE OR REPLACE VIEW V_USUARIO_PERFILES_ACTIVOS AS
SELECT 
    u.ID_USUARIO,
    u.IDENTIFICADOR,
    u.NOMBRE || ' ' || u.APELLIDO1 || ' ' || COALESCE(u.APELLIDO2, '') AS NOMBRE_COMPLETO,
    u.EMAIL,
    up.ID_USUARIO_PERFIL,
    tp.ID_TIPO_PERFIL,
    tp.CODIGO AS CODIGO_PERFIL,
    tp.NOMBRE AS NOMBRE_PERFIL,
    tp.ORDEN_JERARQUICO,
    e.ID_ENTIDAD,
    e.TIPO_ENTIDAD,
    e.NOMBRE AS NOMBRE_ENTIDAD,
    e.CIF_NIF AS CIF_ENTIDAD,
    up.FECHA_ALTA AS FECHA_ASIGNACION_PERFIL,
    up.FECHA_ACTIVACION
FROM USUARIO u
INNER JOIN USUARIO_PERFIL up ON u.ID_USUARIO = up.ID_USUARIO
INNER JOIN TIPO_PERFIL tp ON up.ID_TIPO_PERFIL = tp.ID_TIPO_PERFIL
LEFT JOIN ENTIDAD e ON up.ID_ENTIDAD = e.ID_ENTIDAD
WHERE u.ESTADO = 'ACTIVO'
  AND up.ESTADO = 'ACTIVO'
  AND tp.ESTADO = 'ACTIVO'
  AND (e.ID_ENTIDAD IS NULL OR e.ESTADO = 'ACTIVA');

COMMENT ON VIEW V_USUARIO_PERFILES_ACTIVOS IS 'Vista de usuarios con sus perfiles activos y entidades asociadas';
```

---

### 4.2 Vista de Permisos por Perfil

```sql
CREATE OR REPLACE VIEW V_PERMISOS_PERFIL AS
SELECT 
    tp.ID_TIPO_PERFIL,
    tp.CODIGO AS CODIGO_PERFIL,
    tp.NOMBRE AS NOMBRE_PERFIL,
    f.ID_FUNCIONALIDAD,
    f.CODIGO AS CODIGO_FUNCIONALIDAD,
    f.NOMBRE AS NOMBRE_FUNCIONALIDAD,
    f.TIPO AS TIPO_FUNCIONALIDAD,
    f.RUTA,
    f.ICONO,
    pp.TIPO_PERMISO,
    f.ID_FUNCIONALIDAD_PADRE,
    f.ORDEN
FROM TIPO_PERFIL tp
INNER JOIN PERFIL_PERMISO pp ON tp.ID_TIPO_PERFIL = pp.ID_TIPO_PERFIL
INNER JOIN FUNCIONALIDAD f ON pp.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD
WHERE tp.ESTADO = 'ACTIVO'
  AND pp.ESTADO = 'ACTIVO'
  AND f.ESTADO = 'ACTIVA';

COMMENT ON VIEW V_PERMISOS_PERFIL IS 'Vista de permisos asignados a cada perfil sobre funcionalidades';
```

---

### 4.3 Vista de Árbol de Funcionalidades

```sql
CREATE OR REPLACE VIEW V_ARBOL_FUNCIONALIDADES AS
SELECT 
    f.ID_FUNCIONALIDAD,
    f.CODIGO,
    f.NOMBRE,
    f.TIPO,
    f.RUTA,
    f.ORDEN,
    f.ICONO,
    f.ID_FUNCIONALIDAD_PADRE,
    fp.CODIGO AS CODIGO_PADRE,
    fp.NOMBRE AS NOMBRE_PADRE,
    LEVEL AS NIVEL_JERARQUICO,
    SYS_CONNECT_BY_PATH(f.NOMBRE, ' > ') AS RUTA_COMPLETA
FROM FUNCIONALIDAD f
LEFT JOIN FUNCIONALIDAD fp ON f.ID_FUNCIONALIDAD_PADRE = fp.ID_FUNCIONALIDAD
WHERE f.ESTADO = 'ACTIVA'
START WITH f.ID_FUNCIONALIDAD_PADRE IS NULL
CONNECT BY PRIOR f.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD_PADRE
ORDER SIBLINGS BY f.ORDEN, f.NOMBRE;

COMMENT ON VIEW V_ARBOL_FUNCIONALIDADES IS 'Vista jerárquica de funcionalidades del sistema';
```

---

### 4.4 Vista de Estadísticas de Acceso

```sql
CREATE OR REPLACE VIEW V_ESTADISTICAS_ACCESO AS
SELECT 
    u.ID_USUARIO,
    u.IDENTIFICADOR,
    u.NOMBRE || ' ' || u.APELLIDO1 AS NOMBRE_COMPLETO,
    tp.CODIGO AS CODIGO_PERFIL,
    tp.NOMBRE AS NOMBRE_PERFIL,
    COUNT(*) AS TOTAL_ACCESOS,
    MAX(aa.FECHA_ACCESO) AS ULTIMO_ACCESO,
    AVG(aa.DURACION_SESION) AS DURACION_PROMEDIO_SESION,
    SUM(CASE WHEN aa.TIPO_AUTENTICACION = 'CLAVE' THEN 1 ELSE 0 END) AS ACCESOS_CLAVE,
    SUM(CASE WHEN aa.TIPO_AUTENTICACION = 'CERTIFICADO_DIGITAL' THEN 1 ELSE 0 END) AS ACCESOS_CERTIFICADO
FROM AUDITORIA_ACCESO aa
INNER JOIN USUARIO u ON aa.ID_USUARIO = u.ID_USUARIO
INNER JOIN USUARIO_PERFIL up ON aa.ID_USUARIO_PERFIL = up.ID_USUARIO_PERFIL
INNER JOIN TIPO_PERFIL tp ON up.ID_TIPO_PERFIL = tp.ID_TIPO_PERFIL
GROUP BY u.ID_USUARIO, u.IDENTIFICADOR, u.NOMBRE, u.APELLIDO1, tp.CODIGO, tp.NOMBRE;

COMMENT ON VIEW V_ESTADISTICAS_ACCESO IS 'Estadísticas de acceso por usuario y perfil';
```

---

## 5. PROCEDIMIENTOS ALMACENADOS

### 5.1 Obtener Permisos de un Usuario con Perfil

```sql
CREATE OR REPLACE PROCEDURE SP_OBTENER_PERMISOS_USUARIO(
    p_id_usuario IN NUMBER,
    p_id_usuario_perfil IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT DISTINCT
        f.ID_FUNCIONALIDAD,
        f.CODIGO,
        f.NOMBRE,
        f.TIPO,
        f.RUTA,
        f.ORDEN,
        f.ICONO,
        f.ID_FUNCIONALIDAD_PADRE,
        pp.TIPO_PERMISO
    FROM USUARIO_PERFIL up
    INNER JOIN PERFIL_PERMISO pp ON up.ID_TIPO_PERFIL = pp.ID_TIPO_PERFIL
    INNER JOIN FUNCIONALIDAD f ON pp.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD
    WHERE up.ID_USUARIO = p_id_usuario
      AND up.ID_USUARIO_PERFIL = p_id_usuario_perfil
      AND up.ESTADO = 'ACTIVO'
      AND pp.ESTADO = 'ACTIVO'
      AND f.ESTADO = 'ACTIVA'
    ORDER BY f.ORDEN, f.NOMBRE;
END;
/

COMMENT ON PROCEDURE SP_OBTENER_PERMISOS_USUARIO IS 'Obtiene las funcionalidades y permisos de un usuario con un perfil específico';
```

**Ejemplo de uso:**

```sql
DECLARE
    v_cursor SYS_REFCURSOR;
BEGIN
    SP_OBTENER_PERMISOS_USUARIO(
        p_id_usuario => 1,
        p_id_usuario_perfil => 5,
        p_cursor => v_cursor
    );
END;
/
```

---

### 5.2 Registrar Acceso de Usuario

```sql
CREATE OR REPLACE PROCEDURE SP_REGISTRAR_ACCESO(
    p_id_usuario IN NUMBER,
    p_id_usuario_perfil IN NUMBER,
    p_tipo_autenticacion IN VARCHAR2,
    p_ip_origen IN VARCHAR2,
    p_navegador IN VARCHAR2,
    p_dispositivo IN VARCHAR2,
    p_sesion_id OUT VARCHAR2,
    p_id_auditoria OUT NUMBER
) AS
BEGIN
    -- Generar ID de sesión único
    p_sesion_id := SYS_GUID();
    
    INSERT INTO AUDITORIA_ACCESO (
        ID_USUARIO,
        ID_USUARIO_PERFIL,
        TIPO_AUTENTICACION,
        IP_ORIGEN,
        NAVEGADOR,
        DISPOSITIVO,
        SESION_ID
    ) VALUES (
        p_id_usuario,
        p_id_usuario_perfil,
        p_tipo_autenticacion,
        p_ip_origen,
        p_navegador,
        p_dispositivo,
        p_sesion_id
    ) RETURNING ID_AUDITORIA_ACCESO INTO p_id_auditoria;
    
    COMMIT;
END;
/

COMMENT ON PROCEDURE SP_REGISTRAR_ACCESO IS 'Registra un nuevo acceso al sistema y devuelve el ID de sesión';
```

**Ejemplo de uso:**

```sql
DECLARE
    v_sesion_id VARCHAR2(255);
    v_id_auditoria NUMBER;
BEGIN
    SP_REGISTRAR_ACCESO(
        p_id_usuario => 1,
        p_id_usuario_perfil => 5,
        p_tipo_autenticacion => 'CLAVE',
        p_ip_origen => '192.168.1.100',
        p_navegador => 'Chrome 120.0',
        p_dispositivo => 'Windows 11',
        p_sesion_id => v_sesion_id,
        p_id_auditoria => v_id_auditoria
    );
    
    DBMS_OUTPUT.PUT_LINE('Sesión ID: ' || v_sesion_id);
    DBMS_OUTPUT.PUT_LINE('Auditoría ID: ' || v_id_auditoria);
END;
/
```

---

### 5.3 Cerrar Sesión de Usuario

```sql
CREATE OR REPLACE PROCEDURE SP_CERRAR_SESION(
    p_sesion_id IN VARCHAR2
) AS
    v_fecha_acceso TIMESTAMP;
    v_duracion NUMBER;
BEGIN
    SELECT FECHA_ACCESO INTO v_fecha_acceso
    FROM AUDITORIA_ACCESO
    WHERE SESION_ID = p_sesion_id
      AND FECHA_CIERRE_SESION IS NULL;
    
    -- Calcular duración en segundos
    v_duracion := EXTRACT(DAY FROM (SYSTIMESTAMP - v_fecha_acceso)) * 86400 +
                  EXTRACT(HOUR FROM (SYSTIMESTAMP - v_fecha_acceso)) * 3600 +
                  EXTRACT(MINUTE FROM (SYSTIMESTAMP - v_fecha_acceso)) * 60 +
                  EXTRACT(SECOND FROM (SYSTIMESTAMP - v_fecha_acceso));
    
    UPDATE AUDITORIA_ACCESO
    SET FECHA_CIERRE_SESION = SYSTIMESTAMP,
        DURACION_SESION = v_duracion
    WHERE SESION_ID = p_sesion_id;
    
    COMMIT;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        NULL; -- Sesión ya cerrada o no existe
END;
/

COMMENT ON PROCEDURE SP_CERRAR_SESION IS 'Cierra una sesión activa y calcula su duración';
```

---

### 5.4 Verificar Permiso de Usuario

```sql
CREATE OR REPLACE FUNCTION FN_VERIFICAR_PERMISO(
    p_id_usuario_perfil IN NUMBER,
    p_codigo_funcionalidad IN VARCHAR2,
    p_tipo_permiso IN VARCHAR2
) RETURN NUMBER AS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM USUARIO_PERFIL up
    INNER JOIN PERFIL_PERMISO pp ON up.ID_TIPO_PERFIL = pp.ID_TIPO_PERFIL
    INNER JOIN FUNCIONALIDAD f ON pp.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD
    WHERE up.ID_USUARIO_PERFIL = p_id_usuario_perfil
      AND f.CODIGO = p_codigo_funcionalidad
      AND (pp.TIPO_PERMISO = p_tipo_permiso OR pp.TIPO_PERMISO = 'COMPLETO')
      AND up.ESTADO = 'ACTIVO'
      AND pp.ESTADO = 'ACTIVO'
      AND f.ESTADO = 'ACTIVA';
    
    RETURN CASE WHEN v_count > 0 THEN 1 ELSE 0 END;
END;
/

COMMENT ON FUNCTION FN_VERIFICAR_PERMISO IS 'Verifica si un usuario con perfil tiene un permiso específico sobre una funcionalidad. Retorna 1 si tiene permiso, 0 si no';
```

**Ejemplo de uso:**

```sql
SELECT FN_VERIFICAR_PERMISO(5, 'ACCION_EXPEDIENTE_CREAR', 'EJECUCION') AS TIENE_PERMISO
FROM DUAL;
```

---

### 5.5 Obtener Menú del Usuario

```sql
CREATE OR REPLACE PROCEDURE SP_OBTENER_MENU_USUARIO(
    p_id_usuario_perfil IN NUMBER,
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    WITH PERMISOS_USUARIO AS (
        SELECT DISTINCT f.ID_FUNCIONALIDAD
        FROM USUARIO_PERFIL up
        INNER JOIN PERFIL_PERMISO pp ON up.ID_TIPO_PERFIL = pp.ID_TIPO_PERFIL
        INNER JOIN FUNCIONALIDAD f ON pp.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD
        WHERE up.ID_USUARIO_PERFIL = p_id_usuario_perfil
          AND up.ESTADO = 'ACTIVO'
          AND pp.ESTADO = 'ACTIVO'
          AND f.ESTADO = 'ACTIVA'
    )
    SELECT 
        f.ID_FUNCIONALIDAD,
        f.CODIGO,
        f.NOMBRE,
        f.TIPO,
        f.RUTA,
        f.ORDEN,
        f.ICONO,
        f.ID_FUNCIONALIDAD_PADRE,
        LEVEL AS NIVEL
    FROM FUNCIONALIDAD f
    WHERE f.ID_FUNCIONALIDAD IN (SELECT ID_FUNCIONALIDAD FROM PERMISOS_USUARIO)
       OR f.ID_FUNCIONALIDAD IN (
           -- Incluir padres aunque no tengan permiso directo
           SELECT DISTINCT f2.ID_FUNCIONALIDAD_PADRE
           FROM FUNCIONALIDAD f2
           WHERE f2.ID_FUNCIONALIDAD IN (SELECT ID_FUNCIONALIDAD FROM PERMISOS_USUARIO)
             AND f2.ID_FUNCIONALIDAD_PADRE IS NOT NULL
       )
    START WITH f.ID_FUNCIONALIDAD_PADRE IS NULL
    CONNECT BY PRIOR f.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD_PADRE
    ORDER SIBLINGS BY f.ORDEN, f.NOMBRE;
END;
/

COMMENT ON PROCEDURE SP_OBTENER_MENU_USUARIO IS 'Obtiene el árbol de menú completo para un usuario según sus permisos';
```

---

## 6. TRIGGERS

### 6.1 Trigger para Actualizar Fecha de Modificación en Usuario

```sql
CREATE OR REPLACE TRIGGER TRG_USUARIO_BEFORE_UPDATE
BEFORE UPDATE ON USUARIO
FOR EACH ROW
BEGIN
    :NEW.FECHA_MODIFICACION := CURRENT_TIMESTAMP;
END;
/
```

---

### 6.2 Trigger para Auto-asignar Perfil TITULAR

```sql
CREATE OR REPLACE TRIGGER TRG_USUARIO_AFTER_INSERT
AFTER INSERT ON USUARIO
FOR EACH ROW
DECLARE
    v_id_tipo_perfil_titular NUMBER;
BEGIN
    -- Obtener el ID del perfil TITULAR
    SELECT ID_TIPO_PERFIL INTO v_id_tipo_perfil_titular
    FROM TIPO_PERFIL
    WHERE CODIGO = 'TITULAR' AND ESTADO = 'ACTIVO';
    
    -- Asignar automáticamente el perfil TITULAR al nuevo usuario
    INSERT INTO USUARIO_PERFIL (
        ID_USUARIO,
        ID_TIPO_PERFIL,
        ESTADO,
        FECHA_ACTIVACION,
        USUARIO_ALTA
    ) VALUES (
        :NEW.ID_USUARIO,
        v_id_tipo_perfil_titular,
        'ACTIVO',
        CURRENT_TIMESTAMP,
        :NEW.USUARIO_CREACION
    );
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        NULL; -- No hay perfil TITULAR configurado
END;
/

COMMENT ON TRIGGER TRG_USUARIO_AFTER_INSERT IS 'Asigna automáticamente el perfil TITULAR a cada nuevo usuario';
```

---

## 7. SECUENCIAS (si no se usa IDENTITY)

En caso de no usar `GENERATED ALWAYS AS IDENTITY`, crear secuencias:

```sql
CREATE SEQUENCE SEQ_USUARIO START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_TIPO_PERFIL START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_ENTIDAD START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_USUARIO_PERFIL START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_FUNCIONALIDAD START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_PERFIL_PERMISO START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_AUDITORIA_ACCESO START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_AUDITORIA_ACCION START WITH 1 INCREMENT BY 1 NOCACHE;
```

---

## 8. CONSIDERACIONES DE OPTIMIZACIÓN

### 8.1 Índices

Se han creado índices en:
- Claves foráneas para mejorar JOINs
- Columnas de estado para filtrados frecuentes
- Columnas de fecha en tablas de auditoría
- Códigos y identificadores únicos

### 8.2 Particionado

- **AUDITORIA_ACCESO**: Particionada por meses usando INTERVAL PARTITIONING
- **AUDITORIA_ACCION**: Considerar particionado similar si se implementa

### 8.3 Vistas Materializadas

Para consultas muy frecuentes, considerar crear vistas materializadas con refresh automático:

```sql
CREATE MATERIALIZED VIEW MV_PERMISOS_USUARIO
BUILD IMMEDIATE
REFRESH FAST ON COMMIT
AS
SELECT 
    up.ID_USUARIO,
    up.ID_USUARIO_PERFIL,
    f.ID_FUNCIONALIDAD,
    f.CODIGO AS CODIGO_FUNCIONALIDAD,
    pp.TIPO_PERMISO
FROM USUARIO_PERFIL up
INNER JOIN PERFIL_PERMISO pp ON up.ID_TIPO_PERFIL = pp.ID_TIPO_PERFIL
INNER JOIN FUNCIONALIDAD f ON pp.ID_FUNCIONALIDAD = f.ID_FUNCIONALIDAD
WHERE up.ESTADO = 'ACTIVO'
  AND pp.ESTADO = 'ACTIVO'
  AND f.ESTADO = 'ACTIVA';

CREATE INDEX IDX_MV_PERMISOS_USUARIO ON MV_PERMISOS_USUARIO(ID_USUARIO, ID_USUARIO_PERFIL);
CREATE INDEX IDX_MV_PERMISOS_FUNCIONALIDAD ON MV_PERMISOS_USUARIO(CODIGO_FUNCIONALIDAD);
```

---

## 9. SEGURIDAD

### 9.1 Virtual Private Database (VPD)

Implementar políticas de seguridad a nivel de fila:

```sql
-- Ejemplo: política para que usuarios solo vean sus propios datos
CREATE OR REPLACE FUNCTION FN_POLICY_USUARIO(
    p_schema VARCHAR2,
    p_object VARCHAR2
) RETURN VARCHAR2 AS
    v_predicate VARCHAR2(2000);
    v_id_usuario NUMBER;
BEGIN
    -- Obtener ID de usuario del contexto de aplicación
    v_id_usuario := SYS_CONTEXT('APP_CONTEXT', 'ID_USUARIO');
    
    IF v_id_usuario IS NOT NULL THEN
        v_predicate := 'ID_USUARIO = ' || v_id_usuario;
    ELSE
        v_predicate := '1=0'; -- No mostrar nada si no hay contexto
    END IF;
    
    RETURN v_predicate;
END;
/

-- Aplicar política
BEGIN
    DBMS_RLS.ADD_POLICY(
        object_schema => 'RASMIA',
        object_name => 'USUARIO_PERFIL',
        policy_name => 'POLICY_USUARIO_PERFIL',
        function_schema => 'RASMIA',
        policy_function => 'FN_POLICY_USUARIO',
        statement_types => 'SELECT'
    );
END;
/
```

### 9.2 Encriptación de Datos Sensibles

Activar TDE (Transparent Data Encryption) para columnas sensibles:

```sql
-- Crear tablespace encriptado
CREATE TABLESPACE TS_RASMIA_SECURE
DATAFILE 'rasmia_secure01.dbf' SIZE 100M
ENCRYPTION USING 'AES256'
DEFAULT STORAGE(ENCRYPT);

-- Encriptar columnas específicas
ALTER TABLE USUARIO MODIFY (EMAIL ENCRYPT USING 'AES256');
```

---

## 10. SCRIPTS DE MANTENIMIENTO

### 10.1 Limpieza de Auditorías Antiguas

```sql
-- Procedimiento para archivar y limpiar auditorías de más de 2 años
CREATE OR REPLACE PROCEDURE SP_LIMPIAR_AUDITORIA_ANTIGUA AS
    v_fecha_limite TIMESTAMP;
BEGIN
    v_fecha_limite := ADD_MONTHS(SYSTIMESTAMP, -24); -- 2 años atrás
    
    -- Opcional: exportar a tabla de archivo histórico
    INSERT INTO AUDITORIA_ACCESO_HISTORICO
    SELECT * FROM AUDITORIA_ACCESO
    WHERE FECHA_ACCESO < v_fecha_limite;
    
    -- Eliminar registros antiguos
    DELETE FROM AUDITORIA_ACCESO
    WHERE FECHA_ACCESO < v_fecha_limite;
    
    COMMIT;
END;
/
```

### 10.2 Reporte de Perfiles sin Uso

```sql
-- Vista de perfiles que nunca han sido utilizados
CREATE OR REPLACE VIEW V_PERFILES_SIN_USO AS
SELECT 
    up.ID_USUARIO_PERFIL,
    u.IDENTIFICADOR,
    u.NOMBRE || ' ' || u.APELLIDO1 AS NOMBRE_USUARIO,
    tp.CODIGO AS CODIGO_PERFIL,
    tp.NOMBRE AS NOMBRE_PERFIL,
    up.FECHA_ALTA,
    TRUNC(SYSDATE - CAST(up.FECHA_ALTA AS DATE)) AS DIAS_SIN_USO
FROM USUARIO_PERFIL up
INNER JOIN USUARIO u ON up.ID_USUARIO = u.ID_USUARIO
INNER JOIN TIPO_PERFIL tp ON up.ID_TIPO_PERFIL = tp.ID_TIPO_PERFIL
WHERE up.ESTADO = 'ACTIVO'
  AND NOT EXISTS (
      SELECT 1 FROM AUDITORIA_ACCESO aa
      WHERE aa.ID_USUARIO_PERFIL = up.ID_USUARIO_PERFIL
  );
```

---

## 11. DIAGRAMA CONCEPTUAL

### Relaciones principales:

```
USUARIO (1) ----< (N) USUARIO_PERFIL (N) >---- (1) TIPO_PERFIL
                           |
                           | (N)
                           |
                           V (0..1)
                        ENTIDAD

TIPO_PERFIL (1) ----< (N) PERFIL_PERMISO (N) >---- (1) FUNCIONALIDAD

USUARIO_PERFIL (1) ----< (N) AUDITORIA_ACCESO (1) >---- (N) AUDITORIA_ACCION
```

---

## 12. CONSULTAS ÚTILES

### 12.1 Listar usuarios con sus perfiles y entidades

```sql
SELECT * FROM V_USUARIO_PERFILES_ACTIVOS
ORDER BY NOMBRE_COMPLETO, ORDEN_JERARQUICO;
```

### 12.2 Obtener todos los permisos de un perfil específico

```sql
SELECT * FROM V_PERMISOS_PERFIL
WHERE CODIGO_PERFIL = 'SERVICIO_CENTRAL'
ORDER BY TIPO_FUNCIONALIDAD, ORDEN;
```

### 12.3 Verificar si un usuario tiene un permiso específico

```sql
SELECT FN_VERIFICAR_PERMISO(5, 'ACCION_EXPEDIENTE_APROBAR', 'EJECUCION') AS TIENE_PERMISO
FROM DUAL;
```

### 12.4 Obtener estadísticas de uso por perfil

```sql
SELECT 
    tp.NOMBRE AS PERFIL,
    COUNT(DISTINCT aa.ID_USUARIO) AS USUARIOS_UNICOS,
    COUNT(*) AS TOTAL_ACCESOS,
    TRUNC(AVG(aa.DURACION_SESION)/60, 2) AS DURACION_PROMEDIO_MIN
FROM AUDITORIA_ACCESO aa
INNER JOIN USUARIO_PERFIL up ON aa.ID_USUARIO_PERFIL = up.ID_USUARIO_PERFIL
INNER JOIN TIPO_PERFIL tp ON up.ID_TIPO_PERFIL = tp.ID_TIPO_PERFIL
WHERE aa.FECHA_ACCESO >= TRUNC(SYSDATE, 'MM') -- Mes actual
GROUP BY tp.NOMBRE
ORDER BY TOTAL_ACCESOS DESC;
```

### 12.5 Listar usuarios con perfiles pendientes de activación

```sql
SELECT 
    u.IDENTIFICADOR,
    u.NOMBRE || ' ' || u.APELLIDO1 AS NOMBRE_COMPLETO,
    tp.NOMBRE AS PERFIL_SOLICITADO,
    e.NOMBRE AS ENTIDAD,
    up.FECHA_ALTA AS FECHA_SOLICITUD,
    TRUNC(SYSDATE - CAST(up.FECHA_ALTA AS DATE)) AS DIAS_PENDIENTE
FROM USUARIO_PERFIL up
INNER JOIN USUARIO u ON up.ID_USUARIO = u.ID_USUARIO
INNER JOIN TIPO_PERFIL tp ON up.ID_TIPO_PERFIL = tp.ID_TIPO_PERFIL
LEFT JOIN ENTIDAD e ON up.ID_ENTIDAD = e.ID_ENTIDAD
WHERE up.ESTADO = 'PENDIENTE'
ORDER BY DIAS_PENDIENTE DESC;
```

---

## 13. RESUMEN DE TABLAS

| Tabla | Descripción | Registros estimados |
|-------|-------------|---------------------|
| USUARIO | Usuarios del sistema | Miles |
| TIPO_PERFIL | Catálogo de perfiles | Decenas |
| ENTIDAD | Empresas, organismos, etc. | Miles |
| USUARIO_PERFIL | Asignación usuario-perfil | Decenas de miles |
| FUNCIONALIDAD | Catálogo de funcionalidades | Cientos |
| PERFIL_PERMISO | Permisos por perfil | Miles |
| AUDITORIA_ACCESO | Registro de accesos | Millones (particionada) |
| AUDITORIA_ACCION | Registro de acciones | Millones (futura) |

---

## 14. PRÓXIMOS PASOS

1. **Revisión y validación** del modelo con el equipo
2. **Creación del esquema** en entorno de desarrollo
3. **Carga de datos maestros** (tipos de perfil, funcionalidades iniciales)
4. **Desarrollo de la capa de acceso a datos** en Java/Spring
5. **Implementación de la seguridad** (JWT, integración con MFE)
6. **Pruebas de rendimiento** y ajuste de índices
7. **Implementación de auditoría detallada** (AUDITORIA_ACCION)

---

**Fecha:** 20 de noviembre de 2025  
**Versión:** 1.0  
**Autor:** Propuesta para RASMIA
